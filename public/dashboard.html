<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Shift Key Mechanics</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>

<body>

    <header>
        <div class="container">
            <div class="logo">
                <a href="/">
                    <h1>SHIFT KEY <span style="color:white; font-size: 0.8em; font-weight: 300;">MECHANICS</span></h1>
                </a>
            </div>
            <nav>
                <ul>
                    <li><a href="/">Home</a></li>
                    <li><a href="#" onclick="logout()">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container section">
        <div class="dashboard-header"
            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2 id="user-greeting">Welcome</h2>
            <button class="btn-primary" onclick="window.location.href='/'">Book New Appointment</button>
        </div>

        <div class="dashboard-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:2rem;">

            <!-- My Garage -->
            <div class="card"
                style="background:#fff; padding:2rem; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h3>My Garage</h3>
                    <button class="btn-primary" style="font-size:0.8rem; padding:0.5rem 1rem;"
                        onclick="openAddVehicleModal()">+ Add Vehicle</button>
                </div>
                <div id="vehicleList">
                    <p>Loading vehicles...</p>
                </div>
            </div>

            <!-- Service History -->
            <div class="card"
                style="background:#fff; padding:2rem; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
                <h3>Service History</h3>
                <div id="historyList" style="margin-top:1rem;">
                    <p>Loading history...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div class="modal" id="addVehicleModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAddVehicleModal()">&times;</span>
            <h3>Add New Vehicle</h3>
            <form id="addVehicleForm">
                <div class="form-group">
                    <label>Make</label>
                    <input type="text" id="dash-make" required placeholder="Toyota">
                </div>
                <div class="form-group">
                    <label>Model</label>
                    <input type="text" id="dash-model" required placeholder="Camry">
                </div>
                <div class="form-group">
                    <label>Year</label>
                    <input type="number" id="dash-year" required placeholder="2020">
                </div>
                <div class="form-group">
                    <label>License Plate</label>
                    <input type="text" id="dash-plate" required placeholder="ABC-123">
                </div>
                <div class="form-group">
                    <label>VIN (Optional)</label>
                    <input type="text" id="dash-vin" placeholder="VIN number">
                </div>
                <button type="submit" class="btn-primary">Save Vehicle</button>
            </form>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        // Inline logic for dashboard specific stuff

        async function loadDashboard() {
            checkAuth(); // Redirects if not logged in

            // Load Vehicles
            try {
                const profile = await fetchAPI('/users/profile');
                const list = document.getElementById('vehicleList');
                if (profile.vehicles.length === 0) {
                    list.innerHTML = '<p style="color:#666;">No vehicles added yet.</p>';
                } else {
                    list.innerHTML = profile.vehicles.map(v => `
                        <div style="border-bottom:1px solid #eee; padding:1rem 0;">
                            <strong>${v.year} ${v.make} ${v.model}</strong><br>
                            <span style="color:#666; font-size:0.9rem;">Plate: ${v.license_plate}</span>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error(e);
            }

            // Load History
            try {
                const history = await fetchAPI('/users/appointments');
                const list = document.getElementById('historyList');
                if (history.length === 0) {
                    list.innerHTML = '<p style="color:#666;">No service history.</p>';
                } else {
                    list.innerHTML = history.map(h => `
                        <div style="border-bottom:1px solid #eee; padding:1rem 0;">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${h.service_name}</strong>
                                <span style="font-size:0.8rem; padding:0.2rem 0.5rem; border-radius:4px; background:${getStatusColor(h.status)}; color:#fff;">${h.status}</span>
                            </div>
                            <small style="color:#666;">${new Date(h.appointment_date).toLocaleDateString()} at ${h.appointment_time}</small><br>
                            <small>Vehicle: ${h.license_plate}</small>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error(e);
            }
        }

        function getStatusColor(status) {
            if (status === 'Pending') return '#6c757d';
            if (status === 'Confirmed') return '#17a2b8';
            if (status === 'In-Progress') return '#007bff';
            if (status === 'Completed') return '#28a745';
            return '#dc3545';
        }

        function openAddVehicleModal() {
            document.getElementById('addVehicleModal').classList.add('active');
        }

        function closeAddVehicleModal() {
            document.getElementById('addVehicleModal').classList.remove('active');
        }

        document.getElementById('addVehicleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const make = document.getElementById('dash-make').value;
            const model = document.getElementById('dash-model').value;
            const year = document.getElementById('dash-year').value;
            const license_plate = document.getElementById('dash-plate').value;
            const vin = document.getElementById('dash-vin').value;

            try {
                await fetchAPI('/users/vehicles', 'POST', { make, model, year, license_plate, vin });
                closeAddVehicleModal();
                loadDashboard(); // Refresh
                e.target.reset();
            } catch (err) {
                alert(err.message);
            }
        });

        loadDashboard();
    </script>
</body>

</html>